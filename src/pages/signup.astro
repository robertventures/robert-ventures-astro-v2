---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import { Image } from "astro:assets";
import steve from "../images/testimonials/steve-lloyd.png";

const pageTitle = "Robert Ventures: Sign Up";
const pageDescription =
	"Create your account with Robert Ventures and start your investment journey.";
---

<!doctype html>
<html lang="en">
	<head>
		<BaseHead title={pageTitle} description={pageDescription} />
		<meta name="robots" content="noindex, nofollow" />
		<style>
			body {
				background-color: #fff;
			}
			main {
				padding: 1.5rem 0;
				max-width: 366px;
				margin: 0 auto;
			}

			h1 {
				color: #000;
				text-align: center;
				font-family: "Satoshi", sans-serif;
				font-size: 1.4375rem;
				font-weight: 700;
				line-height: 130%;
				margin-bottom: 1.5rem;
			}

			form {
				display: flex;
				flex-direction: column;
				gap: 0.75rem;
			}

			form input {
				padding: 1rem 0.75rem;
				font-size: 1rem;
				font-family: Inter, sans-serif;
				border-radius: 0.75rem;
				border: 1px solid #afb5bc;
			}

			.group {
				display: flex;
				gap: 0.75rem;
			}

			.group input {
				flex: 1;
				min-width: 0;
			}

			button {
				background-color: #5028ff;
				color: #fff;
				padding: 15px;
				font-family: Inter, sans-serif;
				font-size: 1.125rem;
				font-weight: 500;
				border-radius: 0.75rem;
				border: 1px solid #5028ff;
				margin-top: 0.75rem;
				cursor: pointer;
			}

			.signup-error {
				color: red;
				text-align: center;
				display: none;
				font-size: 0.875rem;
			}

			.disclaimer {
				margin-top: 0.75rem;
				font-family: Inter, sans-serif;
				font-size: 12px;
				text-align: center;
				margin-bottom: 3rem;

				color: #828282;

				line-height: 1.1;
			}

			a {
				color: #505050;
				text-decoration: underline;
				font-weight: 500;
			}

			.testimonial-photos {
				display: flex;
				justify-content: center;
				margin-bottom: 0.75rem;
			}

			.testimonial-photos img {
				max-width: 80px;
				height: auto;
			}

			.testimonial {
				text-align: center;
				font-family: "Inter", sans-serif;
				font-size: 1rem;
				color: #505050;
				margin-bottom: 0.75rem;
			}

			.testimonial-name {
				text-align: center;
				font-family: "Inter", sans-serif;
				font-size: 1.125rem;
				line-height: 1.6;
				font-weight: 500;
			}

			.loader {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				background-color: white;
				display: inline-block;
				animation: pulse 1s infinite;
			}

			@keyframes pulse {
				0% {
					transform: scale(1);
					opacity: 1;
				}
				50% {
					transform: scale(1.5);
					opacity: 0.5;
				}
				100% {
					transform: scale(1);
					opacity: 1;
				}
			}

			ul.password-validation {
				list-style-type: none;
				padding-left: 0;
				font-size: 0.875rem;
				display: none; /* Hide by default */
			}

			ul.password-validation li {
				display: flex;
				gap: 0.5rem;

				align-items: center;
			}
		</style>
		<!-- Meta Pixel Code -->
		<script is:inline>
			!(function (f, b, e, v, n, t, s) {
				if (f.fbq) return;
				n = f.fbq = function () {
					n.callMethod
						? n.callMethod.apply(n, arguments)
						: n.queue.push(arguments);
				};
				if (!f._fbq) f._fbq = n;
				n.push = n;
				n.loaded = !0;
				n.version = "2.0";
				n.queue = [];
				t = b.createElement(e);
				t.async = !0;
				t.src = v;
				s = b.getElementsByTagName(e)[0];
				s.parentNode.insertBefore(t, s);
			})(
				window,
				document,
				"script",
				"https://connect.facebook.net/en_US/fbevents.js",
			);
			fbq("init", "652212003052612");
			fbq("track", "PageView");
			fbq("track", "Lead");
		</script>
		<noscript>
			<img
				height="1"
				width="1"
				style="display:none"
				src="https://www.facebook.com/tr?id=652212003052612&ev=PageView&noscript=1"
			/>
		</noscript>
		<!-- End Meta Pixel Code -->

		<!-- Google tag (gtag.js) -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=AW-10852233213"
		></script>
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());
			gtag("config", "AW-10852233213");
		</script>

		<!-- Event snippet for Rv website - submit lead form conversion page -->
		<script is:inline>
			gtag("event", "conversion", {
				send_to: "AW-10852233213/BmIMCMX8lZ0aEP3f37Yo",
			});
		</script>
		<!-- End Google tag (gtag.js) -->
	</head>
	<body>
		<Header />

		<main>
			<h1>Add Personal Details</h1>

			<form id="signup-form">
				<div class="group">
					<input
						type="text"
						name="first_name"
						placeholder="First Name"
						required
					/>
					<input
						type="text"
						name="last_name"
						placeholder="Last Name"
						required
					/>
				</div>
				<input
					type="tel"
					id="phone"
					name="phone_number"
					placeholder="Phone Number"
					required
				/>

				<p class="signup-error"></p>

				<button type="submit">
					<span class="button-text">Get Started</span>
					<span class="loader" style="display: none;"></span>
				</button>
			</form>

			<p class="disclaimer">
				By clicking get started, you consent to Robert Ventures sending you
				emails and text messages.
			</p>

			<div class="testimonials">
				<div class="testimonial-photos">
					<Image src={steve} alt="A description of my image." />
				</div>
				<p class="testimonial">
					“I've known Joe for over a decade now and he has been more
					than just a friend but has been instrumental in our holding
					company to make accountable double-digit returns and has
					been a blessing. Always could count on him for the
					payments.”
				</p>
				<p class="testimonial-name">Steve Lloyd.</p>
			</div>
		</main>

		<Footer />

		<script is:inline>
			document.addEventListener("DOMContentLoaded", async () => {
				const form = document.getElementById("signup-form");
				const errorElement = document.querySelector(".signup-error");
				const button = form.querySelector("button[type='submit']");
				const buttonText = button.querySelector(".button-text");
				const loader = button.querySelector(".loader");

				const phoneInput = document.getElementById("phone");

				phoneInput.addEventListener("input", (e) => {
					let value = e.target.value.replace(/\D/g, ""); // Remove non-numeric characters

					// Ensure it always starts with +1
					if (!value.startsWith("1")) {
						value = "1" + value;
					}

					// Format phone number as +1 (XXX) XXX-XXXX
					let formattedNumber = "+1";
					if (value.length > 1) {
						formattedNumber += " (" + value.substring(1, 4);
					}
					if (value.length >= 4) {
						formattedNumber += ") " + value.substring(4, 7);
					}
					if (value.length >= 7) {
						formattedNumber += "-" + value.substring(7, 11);
					}

					e.target.value = formattedNumber;
				});

				form.addEventListener("submit", async (e) => {
					e.preventDefault();
					console.log("Form submitted"); // Add this line to log form submission
					errorElement.style.display = "none";
					button.disabled = true;
					buttonText.style.display = "none";
					loader.style.display = "inline-block";

					const formData = new FormData(form);
					const data = Object.fromEntries(formData.entries());

					// Retrieve the email from localStorage and add it to the data object
					const storedEmail = localStorage.getItem("userEmail");
					if (storedEmail) {
						data.email = storedEmail;
					} else {
						console.warn("⚠ No email found in localStorage.");
					}

					// Retrieve the phone number value
					const phoneValue = document
						.getElementById("phone")
						.value.replace(/\D/g, ""); // Remove non-numeric characters

					if (phoneValue.length !== 11 || !phoneValue.startsWith("1")) {
						console.warn(
							"⚠ Invalid phone number entered:",
							phoneValue,
						);
						alert("Please enter a valid US phone number.");
						button.disabled = false;
						buttonText.style.display = "inline";
						loader.style.display = "none";
						return;
					}

					// Add the phone number to the data object
					data.phone_number = phoneValue;

					try {
						const response = await fetch("/api/signup", {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(data),
						});

						const result = await response.json(); // Parse the response

						if (!response.ok) {
							throw new Error(
								result.error ||
									"Signup failed. Please try again.",
							);
						}

						// ✅ Store GHL Contact ID in localStorage
						if (result.ghl_contact_id) {
							localStorage.setItem(
								"ghl_contact_id",
								result.ghl_contact_id,
							);
							console.log(
								"✅ GHL Contact ID saved:",
								result.ghl_contact_id,
							);
						} else {
							console.warn("⚠ No GHL Contact ID received.");
						}

						console.log("✅ Signup successful! Redirecting...");
						triggerEvent("account_created", "accountCreated");
						window.location.href = "/step-2";
					} catch (error) {
						console.error("❌ Error during signup:", error);
						errorElement.textContent = error.message;
						errorElement.style.display = "block";
					} finally {
						button.disabled = false;
						buttonText.style.display = "inline";
						loader.style.display = "none";
					}
				});
			});
		</script>
	</body>
</html>
