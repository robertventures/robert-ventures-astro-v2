---
import BaseHead from "../components/BaseHead.astro";

import Header from "../components/Header.astro";
import FooterNew from "../components/FooterNew.astro";

const pageTitle = "Robert Ventures: Calendar";
const pageDescription = "Book a meeting with the Robert Ventures team.";
---

<!doctype html>
<html lang="en">
    <head>
        <BaseHead title={pageTitle} description={pageDescription} />

        <style>
            section {
                margin-bottom: 1.5rem;
                padding: 0;
            }

            .section-container {
                margin: 0 auto;
                border-radius: 1rem;
                background: #fff;
                padding: 48px 16px;
            }

            .section-content {
                max-width: 640px;
                margin: 0 auto;
            }

            h1 {
                color: #152429;
                font-size: 32px;
                font-weight: 500;
                line-height: 1.1;
                margin-bottom: 1rem;
                font-variant-numeric: lining-nums;
            }

            @media only screen and (min-width: 600px) {
                h1 {
                    font-size: 40px;
                }
            }

            p {
                margin-bottom: 3rem;
                text-align: left;
                color: #30414D;
            }

            .section-heading {
                display: flex;
                flex-direction: column;
                gap: 16px;
                margin-bottom: 32px;
            }

            .section-heading h1 {
                margin-bottom: 0;
            }

            .section-heading p {
                margin-bottom: 0;
                font-size: 20px;
                font-weight: 400;
                line-height: 150%;
                font-family: 'Roboto', sans-serif;
            }

            @media only screen and (min-width: 600px) and (max-width: 1135px) {
                section {
                    padding: 0;
                }
                .section-container {
                    padding: 64px 32px;
                    max-width: none;
                }
            }

            @media only screen and (min-width: 1136px) {
                section {
                    padding: 0;
                }
                .section-container {
                    padding: 96px 112px;
                    max-width: none;
                }
            }

            @media only screen and (min-width: 1920px) {
                section {
                    padding: 0;
                }
                .section-container {
                    padding: 96px 312px;
                    max-width: none;
                }
            }
        </style>
    </head>
    <body>
        <Header />

        <section>
            <div class="section-container">
                <div class="section-content">
                    <div class="section-heading">
                        <h1>Ready to Earn 10% Annually?</h1>
                        <p>Start with a Personal Concierge Call.</p>
                    </div>
                    <iframe
                        src=""
                        style="width: 100%;border:none;overflow: hidden;"
                        scrolling="no"
                        id="calendar-iframe"></iframe><br />
                    
                    <script is:inline>
                        // Build iframe URL with UTM parameters immediately (before DOMContentLoaded)
                        // This ensures params are captured from the URL on first page load
                        (function() {
                            const iframe = document.getElementById('calendar-iframe');
                            if (!iframe) return;
                            
                            const baseUrl = 'https://api.leadconnectorhq.com/widget/booking/xNXEISjf314X2BFZvdaZ';
                            const iframeParams = new URLSearchParams();
                            const urlParams = new URLSearchParams(window.location.search);
                            
                            // Helper: get param from URL first, then localStorage
                            function getParam(key) {
                                return urlParams.get(key) || localStorage.getItem(key) || null;
                            }
                            
                            // Standard UTM parameters
                            const utmKeys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'utm_id'];
                            utmKeys.forEach(key => {
                                const value = getParam(key);
                                if (value) iframeParams.set(key, value);
                            });
                            
                            // Google Ads: Check for gclid and map Google params to UTM fields
                            const gclid = getParam('gclid');
                            if (gclid) {
                                // Pass gclid to GHL (standard field)
                                iframeParams.set('gclid', gclid);
                                
                                // Set UTM defaults for Google Ads if not already set
                                if (!iframeParams.has('utm_source')) {
                                    iframeParams.set('utm_source', 'google');
                                }
                                if (!iframeParams.has('utm_medium')) {
                                    iframeParams.set('utm_medium', 'cpc');
                                }
                                
                                // Map gad_campaignid to utm_campaign
                                const gadCampaignId = getParam('gad_campaignid');
                                if (gadCampaignId && !iframeParams.has('utm_campaign')) {
                                    iframeParams.set('utm_campaign', gadCampaignId);
                                }
                                
                                // Map h_keyword to utm_term
                                const hKeyword = getParam('h_keyword');
                                if (hKeyword && !iframeParams.has('utm_term')) {
                                    iframeParams.set('utm_term', hKeyword);
                                }
                            }
                            
                            // Build and set iframe URL
                            const queryString = iframeParams.toString();
                            iframe.src = queryString ? `${baseUrl}?${queryString}` : baseUrl;
                            console.log('Calendar iframe URL:', iframe.src);
                        })();
                    </script>
                </div>
            </div>
        </section>

        <FooterNew />

        <!-- FORM HANDLER -->
        <script src="/scripts/formHandler.js" defer/>
        <script
            is:inline
            src="https://link.msgsndr.com/js/form_embed.js"
            type="text/javascript"></script>
        
        <script>
            // Function to trigger events for Microsoft Clarity and GA4
            function triggerEvent(eventName, clarityEventName) {
                // Push event to Google Tag Manager's dataLayer
                if ((window as any).dataLayer) {
                    (window as any).dataLayer.push({
                        'event': eventName
                    });
                    console.log('GA4 event triggered: ' + eventName);
                } else {
                    console.warn('dataLayer is not defined. Ensure Google Tag Manager is properly initialized.');
                }

                // Send event to Microsoft Clarity
                if (typeof (window as any).clarity === 'function') {
                    (window as any).clarity('event', clarityEventName);
                    console.log('Clarity event triggered: ' + clarityEventName);
                } else {
                    console.warn('Microsoft Clarity is not initialized.');
                }
            }

            // Listen for messages from the iframe
            document.addEventListener('DOMContentLoaded', function() {
                window.addEventListener('message', function(event) {
                    // Check if the message is from LeadConnector
                    if (event.origin === 'https://api.leadconnectorhq.com') {
                        try {
                            const data = event.data;
                            
                            // Check for booking completion events
                            if (data && typeof data === 'object') {
                                // Look for various booking completion indicators
                                if (data.type === 'booking_completed' || 
                                    data.event === 'booking_completed' ||
                                    data.action === 'booking_completed' ||
                                    data.status === 'completed' ||
                                    (data.message && data.message.includes('booking')) ||
                                    (data.data && data.data.booking)) {
                                    
                                    console.log('Calendar booking detected:', data);
                                    triggerEvent('calendar_booking', 'calendarBooking');
                                }
                            }
                        } catch (error) {
                            console.error('Error processing iframe message:', error);
                        }
                    }
                });

                // Monitor iframe load events
                const iframe = document.getElementById('calendar-iframe');
                if (iframe) {
                    iframe.addEventListener('load', function() {
                        console.log('Calendar iframe loaded');
                    });
                }
            });
        </script>
    </body>
</html>
